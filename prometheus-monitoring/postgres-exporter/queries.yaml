# Custom PostgreSQL queries for postgres_exporter
# These queries expose business and database metrics to Prometheus

pg_database:
  query: "SELECT pg_database.datname, pg_database_size(pg_database.datname) as size_bytes FROM pg_database"
  master: true
  cache_seconds: 30
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - size_bytes:
        usage: "GAUGE"
        description: "Size of the database in bytes"

pg_stat_user_tables:
  query: |
    SELECT
      schemaname,
      relname,
      seq_scan,
      seq_tup_read,
      idx_scan,
      idx_tup_fetch,
      n_tup_ins,
      n_tup_upd,
      n_tup_del,
      n_live_tup,
      n_dead_tup
    FROM pg_stat_user_tables
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema"
    - relname:
        usage: "LABEL"
        description: "Name of the table"
    - seq_scan:
        usage: "COUNTER"
        description: "Number of sequential scans"
    - seq_tup_read:
        usage: "COUNTER"
        description: "Number of tuples read by sequential scans"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Number of tuples fetched by index scans"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Number of tuples inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Number of tuples updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Number of tuples deleted"
    - n_live_tup:
        usage: "GAUGE"
        description: "Number of live tuples"
    - n_dead_tup:
        usage: "GAUGE"
        description: "Number of dead tuples"

pg_stat_activity:
  query: |
    SELECT
      datname,
      state,
      COUNT(*) as connections
    FROM pg_stat_activity
    WHERE datname IS NOT NULL
    GROUP BY datname, state
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - state:
        usage: "LABEL"
        description: "Connection state"
    - connections:
        usage: "GAUGE"
        description: "Number of connections"

pg_slow_queries:
  query: |
    SELECT
      COUNT(*) as slow_queries
    FROM pg_stat_activity
    WHERE state = 'active'
      AND now() - query_start > interval '5 seconds'
  metrics:
    - slow_queries:
        usage: "GAUGE"
        description: "Number of queries running longer than 5 seconds"

# Business metrics from application tables
business_orders_by_status:
  query: |
    SELECT
      order_status,
      COUNT(*) as count,
      COALESCE(SUM(order_total), 0) as total_amount
    FROM orders
    GROUP BY order_status
  metrics:
    - order_status:
        usage: "LABEL"
        description: "Order status"
    - count:
        usage: "GAUGE"
        description: "Number of orders with this status"
    - total_amount:
        usage: "GAUGE"
        description: "Total amount for orders with this status"

business_users_by_type:
  query: |
    SELECT
      account_type,
      COUNT(*) as count
    FROM users
    GROUP BY account_type
  metrics:
    - account_type:
        usage: "LABEL"
        description: "Account type"
    - count:
        usage: "GAUGE"
        description: "Number of users with this account type"

business_daily_revenue:
  query: |
    SELECT
      DATE(created_at) as date,
      COUNT(*) as orders_count,
      COALESCE(SUM(order_total), 0) as revenue
    FROM orders
    WHERE created_at > NOW() - INTERVAL '7 days'
      AND order_status = 'completed'
    GROUP BY DATE(created_at)
  metrics:
    - date:
        usage: "LABEL"
        description: "Date"
    - orders_count:
        usage: "GAUGE"
        description: "Number of completed orders"
    - revenue:
        usage: "GAUGE"
        description: "Total revenue for the day"

business_product_stock:
  query: |
    SELECT
      name,
      category,
      stock_quantity,
      price
    FROM products
  metrics:
    - name:
        usage: "LABEL"
        description: "Product name"
    - category:
        usage: "LABEL"
        description: "Product category"
    - stock_quantity:
        usage: "GAUGE"
        description: "Current stock quantity"
    - price:
        usage: "GAUGE"
        description: "Product price"

pg_locks_count:
  query: |
    SELECT
      mode,
      COUNT(*) as locks
    FROM pg_locks
    GROUP BY mode
  metrics:
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - locks:
        usage: "GAUGE"
        description: "Number of locks"

pg_cache_hit_ratio:
  query: |
    SELECT
      'cache_hit_ratio' as metric,
      CASE
        WHEN (blks_hit + blks_read) = 0 THEN 0
        ELSE round(blks_hit::numeric / (blks_hit + blks_read), 4)
      END as ratio
    FROM pg_stat_database
    WHERE datname = current_database()
  metrics:
    - metric:
        usage: "LABEL"
        description: "Metric name"
    - ratio:
        usage: "GAUGE"
        description: "Cache hit ratio (0-1)"
